# 15. Арифметика чисел с плавающей запятой: проблемы и ограничения

[Оригинал](https://docs.python.org/3.12/tutorial/floatingpoint.html)

Числа с плавающей запятой представляются аппаратурой компьютера в виде двоичных дробей. Например, десятичная дробь `0.625` имеет значение 6/10 + 2/100 + 5/1000, аналогично двоичная дробь `0.101` равна 1/2 + 0/4 + 1/8. Эти две дроби имеют одинаковое значение, разница лишь в записи — первая представлена в десятичной форме, вторая — в двоичной.

К сожалению, большинство десятичных дробей невозможно точно представить в виде двоичных дробей. В результате введённые вами числа с плавающей запятой часто являются приближениями хранимых машинных значений.

Рассмотрим пример с дробью 1/3. Её можно приблизить в десятичном формате:

```python
0.3
```

или точнее:

```python
0.33
```

или ещё точнее:

```python
0.333
```

Однако сколько бы цифр вы ни использовали, результат всё равно останется приближением.

Точно так же число 0.1 нельзя точно представить в двоичном формате. Его точное представление выглядит следующим образом:

```python
0.0001100110011001100110011001100110011001100110011...
```

Остановитесь на любом конечном числе бит, и получите приближение. Современные компьютеры используют двоичные дроби с числителем длиной до 53 битов и знаменателем степенью двойки. Для числа 0.1 используется приближённое значение:

```python
3602879701896397 / 2 ** 55
```

Это близко к истинному значению 1/10, но не абсолютно точно.

При отображении результатов Python выводит округлённую версию внутреннего представления числа. Если вывести полное внутреннее значение числа 0.1, получится примерно следующее:

```python
0.1000000000000000055511151231257827021181583404541015625
```

Для удобства вывода Python автоматически округляет значение до удобочитаемого вида:

```python
0.1
```

Важно помнить, что даже несмотря на отображаемое значение, хранящееся в памяти значение остаётся приближённым.

Многие разные десятичные числа могут иметь одно и то же приближённое двоичное представление. Например, числа `0.1`, `0.10000000000000001` и
`0.1000000000000000055511151231257827021181583404541015625` будут представлены одинаково:

```python
3602879701896397 / 2 ** 55
```

Начиная с версии Python 3.1, Python выбирает наиболее короткое представление среди возможных вариантов.

Проблема точности характерна для всех языков программирования, использующих стандарт IEEE 754 для арифметики с плавающей запятой. Это не ошибка Python или вашего кода, а особенность работы аппаратуры.

Чтобы улучшить читаемость результата, используйте форматирование строк:

```python
import math

format(math.pi, '.12g')  # выдаёт 12 значимых цифр
'3.14159265359'

format(math.pi, '.2f')   # выдаёт два знака после точки
'3.14'

repr(math.pi)
'3.141592653589793'
```

Даже при таком подходе важно понимать, что отображается лишь округление реального значения.

Сумма трёх значений 0.1 также не даст точного результата:

```python
0.1 + 0.1 + 0.1 == 0.3
False
```

Функция `math.isclose()` полезна для сравнения приближённых значений:

```python
import math

math.isclose(0.1 + 0.1 + 0.1, 0.3)
True
```

Модули `decimal` и `fractions` позволяют проводить точные вычисления:

```python
from decimal import Decimal
from fractions import Fraction

Fraction.from_float(0.1)
Fraction(3602879701896397, 36028797018963968)

Decimal.from_float(0.1)
Decimal('0.1000000000000000055511151231257827021181583404541015625')
```

Таким образом, ошибки округления неизбежны, но редко влияют на точность большинства расчётов. Для особо требовательных случаев рекомендуется использовать модули точной арифметики (`decimal`, `fractions`) или специализированные библиотеки вроде NumPy и SciPy.

## 15.1. Ошибка представления

Ошибка представления возникает потому, что многие десятичные дроби не могут быть точно выражены в виде двоичных дробей. Из-за этого компьютерное представление чисел отличается от ожидаемого человеком.

Например, рассмотрим дробь 1/10. Она представляется в компьютере как бесконечная двоичная дробь:

```python
0.00011001100110011...
```

На большинстве современных компьютеров используются числа с плавающей запятой стандарта IEEE 754, где хранятся дроби с точностью до 53 битов. Число 0.1 представлено приближённо:

```python
3602879701896397 / 2 ** 55
```

Эта дробь близка к 1/10, но не идентична ей.

Из-за этой особенности сумма нескольких значений 0.1 не обязательно даёт ровно 0.3:

```python
0.1 + 0.1 + 0.1 == 0.3
False
```

Несмотря на невозможность получить точное значение, функция `math.isclose()` позволяет сравнивать приближённые результаты:

```python
import math

math.isclose(0.1 + 0.1 + 0.1, 0.3)
True
```

Модуль `fractions` помогает анализировать такие ситуации:

```python
from fractions import Fraction

Fraction.from_float(0.1)
Fraction(3602879701896397, 36028797018963968)
```

Таким образом, проблема ошибок представления является фундаментальной особенностью двоичного формата чисел с плавающей запятой и присуща большинству языков программирования.
